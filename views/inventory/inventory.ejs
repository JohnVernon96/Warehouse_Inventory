<% include ../partials/header %>

<link rel="stylesheet" href="./inventory.css">

<div class="container">
    <h1>Warehouse Inventory</h1>
    <div class="row jumbotron text-white">
        <div class="inv-container col-sm col-md-8 col-lg-12 col-xl-12">
            <p>
                <table class="table table-condensed table-responsive">
                    <!-- <caption>Condensed Table Layout</caption> -->
                    <thead>
                        <tr>
                            <th>Item ID</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Date Recieved</th>
                            <th>Storage Location</th>
                            <th>Quantity</th>
                            <th>Present</th>
                            <th>Reserved</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for(var i = 0; i < items.length; i++) { %>
                        <tr>
                            <td><%= items[i].inv_id %></td>
                            <td><%= items[i].description %></td>
                            <td><%= items[i].category %></td>
                            <td><%= items[i].date_recieved %></td>
                            <td><%= items[i].storage_location %></td>
                            <td><%= items[i].quantity %></td>

                            <!-- PRESENT -->
                            <td>
                                <% if(items[i].present === 'no') { %>
                                <input type="checkbox" disabled>
                                <% } else { %>
                                <input type="checkbox" checked disabled>
                                <% } %>
                            </td>

                            <!-- RESERVED -->
                            <td>
                                <% if(items[i].reserved === 'no') { %>
                                <input type="checkbox" disabled>
                                <% } else { %>
                                <input type="checkbox" checked disabled>
                                <% } %>
                            </td>
                            <td>
                                <button type="button" class="showbtn btn btn-info" data-toggle="modal" data-target="#viewItem" data-id=<%=items[i].inv_id%>>Edit</button>
                            </td>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </p>
            <div class="btn-container">
                <a class="btn btn-primary btn-lg" href="/inventory/new" role="button" id="newItemButton">New Item</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewItem" tabindex="-1" role="dialog" aria-labelledby="viewItemLabel">
    <div class="modal-dialog modal-lg container row" role="document">
        <div class="modal-content inv-container col-sm col-md col-lg col-xl">
            <div class="modal-header">
                <button type="btn btn-sm" class="close" data-dismiss="modal">&times;</button>
                <h3>Item Details</h3>
            </div>
            <div>
                <div style="float:left;margin:3px">
                    <label for="description">Description</label>
                    <input type="text" id="description-input" name="description" value="">
                </div>
                <div style="float:left;margin:3px">
                    <label for="category">Category</label>
                    <input type="text" id="category-input" name="category" value="">
                </div>
                <div style="float:left;margin:3px">
                    <label for="storage_location">Storage Location</label>
                    <input type="text" id="storage-input" name="storage_location" value="">
                </div>
                <div style="float:left;margin:3px">
                    <label for="quantity">Quantity</label>
                    <input type="text" id="quantity-input" name="quantity" value="">
                </div>
                <div style="float:right;margin:3px">
                    <label for="present">Present</label>
                    <input type="checkbox" id="present-input" name="present" value="">
                </div>
                <div style="float:right;margin:3px">
                    <label for="reserved">Reserved</label>
                    <input type="checkbox" id="reserved-input" name="reserved" value="">
                </div>
            </div>
            <div class="modal-body collapse" id="history-table">
            </div>
            <div class="modal-footer">
                <input type="hidden" id="modal-inv-id" name="" value=""/>
                <button type="button" onclick="updateItem()" class="btn btn-default" data-dismiss="modal">Update</button>
                <button type="button" onclick="changeBtnText()" class="btn btn-primary"
                data-toggle="collapse" data-target="#history-table"
                id="show-hide-history-btn">Show History</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">

var getData = async function(id){
    //really ugly function to create a table of inventory history
    const url = `/inv-history/${id}`;
    const resp = await fetch(url, {credentials: 'include'})
    const data = await resp.json()
    const rows = data.results
    let tbl = document.querySelector('.inv-his-table')
    if(tbl) tbl.remove();
    let errH3 = document.querySelector('#error-h3')
    if(errH3) errH3.remove();
    if (data.results.length < 1){
        // document.querySelector('#hiddenvalue').value = "No Item History."
        var modalBod = document.querySelector('.modal-body')
        errH3 = document.createElement('H3');
        errH3.id = 'error-h3';
        errH3.textContent = 'ERROR FETCHING TABLE';
        modalBod.appendChild(errH3);
    }else {

        tbl = document.createElement('TABLE');
        tbl.classList.add('inv-his-table')
        tbl.classList.add('table')
        tbl.classList.add('table-condensed')
        tbl.classList.add('table-responsive')
        tbl.border = '5px';
        var thead = document.createElement('THEAD')
        tbl.appendChild(thead)
        var tabTr = document.createElement('TR')
        thead.appendChild(tabTr)
        for (var key in rows[0]){
            var tabTh = document.createElement('TH')
            tabTh.textContent = key;
            tabTr.appendChild(tabTh)
        }
        var tabBod = document.createElement('tbody')
        tbl.appendChild(tabBod)

        rows.forEach(row => {
            var tabTr = document.createElement('TR');
            tabBod.appendChild(tabTr);
            for(var key in row){
                var tabTh = document.createElement('TH')
                tabTh.textContent = row[key]
                tabTr.appendChild(tabTh)
                // document.querySelector('#hiddenvalue').value += key;
                // document.querySelector('#hiddenvalue').value += ": " + row[key];
            }
        })
        var modalBod = document.querySelector('.modal-body')
        modalBod.appendChild(tbl)
    }
}

const changeBtnText = () => {
    let btnText = document.querySelector('#show-hide-history-btn').textContent;
    if(btnText === 'Show History'){
        document.querySelector('#show-hide-history-btn').textContent = 'Hide History';
    } else {
        document.querySelector('#show-hide-history-btn').textContent = 'Show History';
    }
}

const loadDataOnForms = async function(id){
    const url = `/inv-items/${id}`;
    const resp = await fetch(url, {credentials: 'include'})
    const data = await resp.json()
    console.log(data.results);
    if (data.results.length < 1){
        document.getElementById('description-input').value = 'Error';
    } else {
        rows = data.results;
        document.getElementById('description-input').value = rows[0].description;
        document.getElementById('category-input').value = rows[0].category;
        document.getElementById('storage-input').value = rows[0].storage_location;
        document.getElementById('quantity-input').value = rows[0].quantity;

        if(rows[0].present==='yes')
        document.getElementById('present-input').checked = true

        if(rows[0].reserved==='yes')
        document.getElementById('reserved-input').checked = true
    }
}

const updateItem = async function(){
    //this function sends data obj to api to update db
    const data_id = document.querySelector('#modal-inv-id').value;
    const url = `/inv-items/${data_id}`;
    const data = {
        description: document.getElementById('description-input').value,
        category: document.getElementById('category-input').value,
        storage: document.getElementById('storage-input').value,
        quantity: document.getElementById('quantity-input').value,
        present: document.getElementById('present-input').checked,
        reserved: document.getElementById('reserved-input').checked,
    }
    const resp = fetch(url, {
        method: "PUT",
        credentials: 'include',
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data),
    })
    .then(fetched =>{
        location.reload()
    })

}

$(document).ready(function() {

    $('a[data-toggle=modal], button[data-toggle=modal]').click(function () {

        var data_id = '';
        var data_desc = '';

        if (typeof $(this).data('id') !== 'undefined') {
            data_id = $(this).data('id');
            document.querySelector('#modal-inv-id').value = data_id;
        }

        if (typeof $(this).data('description') !== 'undefined') {
            data_desc = $(this).data('description');
        }

        loadDataOnForms(data_id);

        getData(data_id);
    })
});

</script>

<% include ../partials/footer %>
